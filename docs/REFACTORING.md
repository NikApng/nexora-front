# Рефакторинг архитектуры проекта

## Проблемы до рефакторинга

1. **Бизнес-логика смешана с API роутами** - вся логика в route.ts
2. **Нет слоя сервисов** - отсутствует абстракция бизнес-логики
3. **Нет репозиториев** - прямые запросы к БД в API роутах
4. **Валидация разбросана** - схемы валидации в разных местах
5. **Дублирование кода** - одинаковая логика в разных местах
6. **Константы в компонентах** - навигация определена в компоненте
7. **Компоненты напрямую делают fetch** - нет абстракции для API вызовов

## Что было сделано

### 1. Создана слоистая архитектура

```
┌─────────────────────────────────┐
│   Presentation Layer            │
│   (Components, Pages, Hooks)    │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│   API Layer                     │
│   (Route Handlers)              │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│   Service Layer                 │
│   (Business Logic)              │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│   Repository Layer              │
│   (Data Access)                 │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│   Data Layer                    │
│   (Database)                    │
└─────────────────────────────────┘
```

### 2. Создан Repository Layer

**Файл:** `lib/repositories/user.repository.ts`

- Инкапсулирует все операции с пользователями
- Методы: `findByEmail()`, `findById()`, `create()`, `existsByEmail()`

### 3. Создан Service Layer

**Файл:** `lib/services/auth.service.ts`

- Содержит бизнес-логику авторизации
- Методы: `register()`, `login()`, `hashPassword()`, `comparePassword()`
- Использует репозиторий для работы с данными

### 4. Вынесена валидация

**Файл:** `lib/validations/auth.validation.ts`

- Все схемы Zod в одном месте
- Экспорт типов для TypeScript

### 5. Созданы хуки

**Файл:** `lib/hooks/use-auth.ts`

- `useRegister()` - хук для регистрации
- `useLogin()` - хук для входа
- Инкапсулируют логику работы с API

### 6. Вынесены константы

**Файл:** `lib/constants/navigation.constants.ts`

- Все константы навигации в одном месте

### 7. Рефакторинг API роутов

**До:**
- Вся логика в одном файле
- Прямые запросы к БД
- Валидация внутри роута

**После:**
- Тонкий слой контроллеров
- Используют сервисы
- Валидация через схемы

### 8. Рефакторинг компонентов

**До:**
- Прямые fetch запросы
- Дублирование логики
- Константы внутри компонентов

**После:**
- Используют хуки
- Чистые компоненты
- Константы вынесены

### 9. Улучшена структура БД

- Выделен модуль подключения: `lib/db/connection.ts`
- Обратная совместимость через реэкспорт в `lib/db.ts`

## Новые файлы

### Репозитории
- `lib/repositories/user.repository.ts`
- `lib/repositories/index.ts`

### Сервисы
- `lib/services/auth.service.ts`
- `lib/services/index.ts`

### Валидация
- `lib/validations/auth.validation.ts`

### Хуки
- `lib/hooks/use-auth.ts`

### Константы
- `lib/constants/navigation.constants.ts`

### База данных
- `lib/db/connection.ts`

### Документация
- `docs/ARCHITECTURE.md`
- `docs/REFACTORING.md`

## Обновленные файлы

- `app/api/register/route.ts` - использует сервисы
- `lib/auth/auth.config.ts` - использует сервисы
- `components/forms/RegisterForm.tsx` - использует хуки
- `components/forms/LoginForm.tsx` - использует хуки
- `components/header/nav-item.tsx` - использует константы
- `lib/db.ts` - реэкспорт из connection.ts

## Преимущества новой архитектуры

1. **Тестируемость** - каждый слой можно тестировать независимо
2. **Поддерживаемость** - изменения изолированы в конкретных слоях
3. **Масштабируемость** - легко добавлять новые функции
4. **Переиспользование** - логика вынесена в переиспользуемые модули
5. **Читаемость** - четкая структура и разделение ответственности
6. **Типобезопасность** - все типы определены и используются правильно

## Следующие шаги

1. Добавить тесты для каждого слоя
2. Добавить обработку ошибок на уровне сервисов
3. Добавить логирование
4. Создать миграции для БД через Drizzle Kit
5. Добавить валидацию на клиенте через React Hook Form + Zod

